#!/bin/sh
set -e


colors="$(dirname "${0}")/colors.sh"
if [ -f "${colors}" ]; then
    . "${colors}"
else
    echo >&2 "$(tput setaf 214)[WARNING]$(tput sgr0) Could not find colors.sh file, expected '${colors}'."
    withfg() {
        echo "${2}"
    }
fi

dotfuncs="$(dirname "${0}")/dotfuncs"
if [ -f "${dotfuncs}" ]; then
    . "${dotfuncs}"
else
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find dotfuncs file, expected '${dotfuncs}'."
    exit 127
fi


if [ -n "${1}" ]; then
    basedir="${1}"
elif [ -d "${HOME}/dotsync" ]; then
    basedir="${HOME}/dotsync"
else
    echo >&2 "$(withfg ff0000 '[ERROR]') No dotsync directory found; please specify as first argument (e.g. \`${0} path/to/dotsync\`)."
    exit 127
fi

dotdir="${basedir}/dotfiles"
if [ ! -e "${dotdir}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find dotfile directory at '${dotdir}'"
    exit 127
elif [ ! -d "${dotdir}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find dotfile directory at '${dotdir}'; it exists, but is not a directory."
    exit 127
fi

boxdir="${basedir}/boxen"
if [ ! -e "${boxdir}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find box-config directory at '${boxdir}'"
    exit 127
elif [ ! -d "${boxdir}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find box-config directory at '${boxdir}'; it exists, but is not a directory."
    exit 127
fi

hostconf="${boxdir}/$(hostname)"
if [ ! -e "${hostconf}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find configuration file for host '$(hostname)' at '${hostconf}'."
    exit 127
elif [ ! -f "${hostconf}" ]; then
    echo >&2 "$(withfg ff0000 '[ERROR]') Could not find configuration file for host '$(hostname)' at '${hostconf}'; it is not a regular file."
    exit 127
fi


dotsync "${hostconf}" "${dotdir}"
